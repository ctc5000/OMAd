{
	"info": {
		"_postman_id": "order-master-analytics",
		"name": "Order Master Analytics API",
		"description": "Полное тестирование системы аналитики",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "0. Setup & Initialization",
			"item": [
				{
					"name": "Initialize Test Data",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"type": "text/javascript",
								"exec": [
									"// Генерация уникальных данных для тестов",
									"const timestamp = Date.now();",
									"const random = Math.floor(Math.random() * 1000);",
									"",
									"// Генерируем уникальный session_id",
									"pm.collectionVariables.set(\"random_session_id\", \"session_\" + timestamp + \"_\" + random);",
									"pm.collectionVariables.set(\"current_timestamp\", new Date().toISOString());",
									"",
									"// Устанавливаем тестовые данные",
									"pm.collectionVariables.set(\"test_restaurant_id\", 1);",
									"pm.collectionVariables.set(\"test_campaign_id\", 1001);",
									"pm.collectionVariables.set(\"test_advertiser_id\", 5001);",
									"",
									"console.log(\"Test data initialized:\");",
									"console.log(\"Session ID: \" + pm.collectionVariables.get(\"random_session_id\"));",
									"console.log(\"Restaurant ID: \" + pm.collectionVariables.get(\"test_restaurant_id\"));"
								]
							}
						},
						{
							"listen": "test",
							"script": {
								"type": "text/javascript",
								"exec": [
									"// Проверка инициализации переменных",
									"pm.test(\"Test variables initialized\", function() {",
									"    pm.expect(pm.collectionVariables.get(\"random_session_id\")).to.not.be.empty;",
									"    pm.expect(pm.collectionVariables.get(\"current_timestamp\")).to.not.be.empty;",
									"});"
								]
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/health",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"health"
							]
						}
					},
					"response": []
				}
			]
		},
		{
			"name": "1. Session Management",
			"item": [
				{
					"name": "1.1 Create Session - Minimal Data",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"restaurant_id\": {{test_restaurant_id}},\n  \"restaurant_segment\": \"средний\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/analytics/session-started",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"analytics",
								"session-started"
							]
						}
					},
					"response": [],
					"event": [
						{
							"listen": "test",
							"script": {
								"type": "text/javascript",
								"exec": [
									"// Проверка успешного создания сессии",
									"pm.test(\"Status code is 201\", function() {",
									"    pm.response.to.have.status(201);",
									"});",
									"",
									"pm.test(\"Response has success: true\", function() {",
									"    const jsonData = pm.response.json();",
									"    pm.expect(jsonData.success).to.be.true;",
									"});",
									"",
									"pm.test(\"Session ID is generated\", function() {",
									"    const jsonData = pm.response.json();",
									"    pm.expect(jsonData.data.session_id).to.be.a('string');",
									"    pm.expect(jsonData.data.session_id.length).to.be.greaterThan(10);",
									"    // Сохраняем session_id для последующих тестов",
									"    pm.collectionVariables.set(\"created_session_id\", jsonData.data.session_id);",
									"    console.log(\"Created session ID: \" + jsonData.data.session_id);",
									"});",
									"",
									"pm.test(\"Correct restaurant_id returned\", function() {",
									"    const jsonData = pm.response.json();",
									"    pm.expect(jsonData.data.restaurant_id).to.equal({{test_restaurant_id}});",
									"});"
								]
							}
						}
					]
				},
				{
					"name": "1.2 Create Session - Full Data",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"restaurant_id\": {{test_restaurant_id}},\n  \"restaurant_segment\": \"премиум\",\n  \"user_agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\",\n  \"ip_address\": \"192.168.1.100\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/analytics/session-started",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"analytics",
								"session-started"
							]
						}
					},
					"response": [],
					"event": [
						{
							"listen": "test",
							"script": {
								"type": "text/javascript",
								"exec": [
									"pm.test(\"Status code is 201\", function() {",
									"    pm.response.to.have.status(201);",
									"});",
									"",
									"pm.test(\"Session created with full data\", function() {",
									"    const jsonData = pm.response.json();",
									"    pm.expect(jsonData.success).to.be.true;",
									"    pm.expect(jsonData.data.session_id).to.exist;",
									"    // Сохраняем второй session_id",
									"    pm.collectionVariables.set(\"second_session_id\", jsonData.data.session_id);",
									"});"
								]
							}
						}
					]
				},
				{
					"name": "1.3 Create Session - Invalid restaurant_id",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"restaurant_id\": -1,\n  \"restaurant_segment\": \"средний\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/analytics/session-started",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"analytics",
								"session-started"
							]
						}
					},
					"response": [],
					"event": [
						{
							"listen": "test",
							"script": {
								"type": "text/javascript",
								"exec": [
									"pm.test(\"Status code is 400\", function() {",
									"    pm.response.to.have.status(400);",
									"});",
									"",
									"pm.test(\"Response has success: false\", function() {",
									"    const jsonData = pm.response.json();",
									"    pm.expect(jsonData.success).to.be.false;",
									"});",
									"",
									"pm.test(\"Error message about restaurant_id\", function() {",
									"    const jsonData = pm.response.json();",
									"    pm.expect(jsonData.errors).to.be.an('array');",
									"    pm.expect(jsonData.errors[0]).to.include('restaurant_id');",
									"});"
								]
							}
						}
					]
				},
				{
					"name": "1.4 Create Session - Invalid segment",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"restaurant_id\": {{test_restaurant_id}},\n  \"restaurant_segment\": \"неправильный_сегмент\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/analytics/session-started",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"analytics",
								"session-started"
							]
						}
					},
					"response": [],
					"event": [
						{
							"listen": "test",
							"script": {
								"type": "text/javascript",
								"exec": [
									"pm.test(\"Status code is 400\", function() {",
									"    pm.response.to.have.status(400);",
									"});",
									"",
									"pm.test(\"Error about invalid segment\", function() {",
									"    const jsonData = pm.response.json();",
									"    pm.expect(jsonData.errors).to.include('Некорректный restaurant_segment');",
									"});"
								]
							}
						}
					]
				},
				{
					"name": "1.5 Create Session - Invalid IP",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"restaurant_id\": {{test_restaurant_id}},\n  \"restaurant_segment\": \"средний\",\n  \"ip_address\": \"999.999.999.999\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/analytics/session-started",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"analytics",
								"session-started"
							]
						}
					},
					"response": [],
					"event": [
						{
							"listen": "test",
							"script": {
								"type": "text/javascript",
								"exec": [
									"pm.test(\"Status code is 400\", function() {",
									"    pm.response.to.have.status(400);",
									"});",
									"",
									"pm.test(\"Error about IP address\", function() {",
									"    const jsonData = pm.response.json();",
									"    pm.expect(jsonData.errors).to.include('IP');",
									"});"
								]
							}
						}
					]
				}
			]
		},
		{
			"name": "2. Ad Events",
			"item": [
				{
					"name": "2.1 Ad Impression - Success",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"session_id\": \"{{created_session_id}}\",\n  \"campaign_id\": {{test_campaign_id}},\n  \"advertiser_id\": {{test_advertiser_id}},\n  \"banner_placement\": \"checkout\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/analytics/ad-impression",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"analytics",
								"ad-impression"
							]
						}
					},
					"response": [],
					"event": [
						{
							"listen": "test",
							"script": {
								"type": "text/javascript",
								"exec": [
									"pm.test(\"Impression created - status 201\", function() {",
									"    pm.response.to.have.status(201);",
									"});",
									"",
									"pm.test(\"Impression has ID\", function() {",
									"    const jsonData = pm.response.json();",
									"    pm.expect(jsonData.success).to.be.true;",
									"    pm.expect(jsonData.data).to.have.property('id');",
									"    // Сохраняем impression_id для тестов кликов",
									"    pm.collectionVariables.set(\"impression_id\", jsonData.data.id);",
									"});"
								]
							}
						}
					]
				},
				{
					"name": "2.2 Ad Click - Success",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"session_id\": \"{{created_session_id}}\",\n  \"campaign_id\": {{test_campaign_id}},\n  \"advertiser_id\": {{test_advertiser_id}}\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/analytics/ad-click",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"analytics",
								"ad-click"
							]
						}
					},
					"response": [],
					"event": [
						{
							"listen": "test",
							"script": {
								"type": "text/javascript",
								"exec": [
									"pm.test(\"Click created - status 201\", function() {",
									"    pm.response.to.have.status(201);",
									"});",
									"",
									"pm.test(\"Click recorded successfully\", function() {",
									"    const jsonData = pm.response.json();",
									"    pm.expect(jsonData.success).to.be.true;",
									"    pm.expect(jsonData.data).to.have.property('id');",
									"    pm.collectionVariables.set(\"click_id\", jsonData.data.id);",
									"});"
								]
							}
						}
					]
				},
				{
					"name": "2.3 Ad Conversion - Success",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"session_id\": \"{{created_session_id}}\",\n  \"campaign_id\": {{test_campaign_id}},\n  \"advertiser_id\": {{test_advertiser_id}},\n  \"conversion_type\": \"bank_card_request\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/analytics/ad-conversion",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"analytics",
								"ad-conversion"
							]
						}
					},
					"response": [],
					"event": [
						{
							"listen": "test",
							"script": {
								"type": "text/javascript",
								"exec": [
									"pm.test(\"Conversion created - status 201\", function() {",
									"    pm.response.to.have.status(201);",
									"});",
									"",
									"pm.test(\"Conversion recorded\", function() {",
									"    const jsonData = pm.response.json();",
									"    pm.expect(jsonData.success).to.be.true;",
									"    pm.expect(jsonData.data).to.have.property('id');",
									"    pm.expect(jsonData.data.conversion_type).to.equal('bank_card_request');",
									"});"
								]
							}
						}
					]
				}
			]
		},
		{
			"name": "3. Metrics & Analytics",
			"item": [
				{
					"name": "3.1 Get Metrics - Basic",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/api/analytics/metrics?campaign_id={{test_campaign_id}}",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"analytics",
								"metrics"
							],
							"query": [
								{
									"key": "campaign_id",
									"value": "{{test_campaign_id}}"
								}
							]
						}
					},
					"response": [],
					"event": [
						{
							"listen": "test",
							"script": {
								"type": "text/javascript",
								"exec": [
									"pm.test(\"Metrics retrieved - status 200\", function() {",
									"    pm.response.to.have.status(200);",
									"});",
									"",
									"pm.test(\"Metrics structure is correct\", function() {",
									"    const jsonData = pm.response.json();",
									"    pm.expect(jsonData.success).to.be.true;",
									"    pm.expect(jsonData.data).to.be.an('object');",
									"    pm.expect(jsonData.data).to.have.all.keys([",
									"        'uv', 'reach', 'impressions', 'clicks', 'conversions',",
									"        'ctr', 'cr', 'cpu_v', 'cpc', 'cpl'",
									"    ]);",
									"});"
								]
							}
						}
					]
				}
			]
		},
		{
			"name": "4. Error Scenarios",
			"item": [
				{
					"name": "4.1 Ad Impression - Invalid Session",
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"session_id\": \"non_existent_session_12345\",\n  \"campaign_id\": {{test_campaign_id}},\n  \"advertiser_id\": {{test_advertiser_id}},\n  \"banner_placement\": \"checkout\"\n}"
						},
						"url": {
							"raw": "{{base_url}}/api/analytics/ad-impression",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"api",
								"analytics",
								"ad-impression"
							]
						}
					},
					"response": []
				}
			]
		}
	],
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"type": "text/javascript",
				"exec": [
					"// Этот скрипт выполняется ПЕРЕД каждым запросом в коллекции",
					"// Можно использовать для логгирования",
					"console.log('Request: ' + pm.request.method + ' ' + pm.request.url.toString());"
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"type": "text/javascript",
				"exec": [
					"// Этот скрипт выполняется ПОСЛЕ каждого запроса в коллекции",
					"// Можно использовать для общих проверок",
					"console.log('Response status: ' + pm.response.code);",
					"console.log('Response time: ' + pm.response.responseTime + 'ms');"
				]
			}
		}
	],
	"variable": [
		{
			"key": "base_url",
			"value": "http://localhost:3000"
		}
	]
}