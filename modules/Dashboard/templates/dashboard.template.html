<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üìä Order Master Analytics Dashboard</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  
  body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    color: white;
    padding: 20px;
  }
  
  .dashboard {
    max-width: 1400px;
    margin: 0 auto;
  }
  
  .header {
    text-align: center;
    margin-bottom: 30px;
    padding: 20px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }
  
  .header h1 {
    font-size: 2.5rem;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
  }
  
  .period-selector {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 20px;
  }
  
  .period-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s;
  }
  
  .period-btn:hover,
  .period-btn.active {
    background: rgba(255, 255, 255, 0.4);
  }
  
  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }
  
  .metric-card {
    background: rgba(255, 255, 255, 0.1);
    padding: 20px;
    border-radius: 12px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: transform 0.3s;
  }
  
  .metric-card:hover {
    transform: translateY(-5px);
  }
  
  .metric-value {
    font-size: 2.2rem;
    font-weight: bold;
    margin: 10px 0;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .metric-change {
    font-size: 0.9rem;
    padding: 2px 8px;
    border-radius: 12px;
    display: inline-block;
  }
  
  .positive {
    background: rgba(46, 204, 113, 0.3);
    color: #2ecc71;
  }
  
  .negative {
    background: rgba(231, 76, 60, 0.3);
    color: #e74c3c;
  }
  
  .metric-label {
    font-size: 0.9rem;
    opacity: 0.8;
    margin-top: 5px;
  }
  
  .charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }
  
  .chart-card {
    background: rgba(255, 255, 255, 0.1);
    padding: 20px;
    border-radius: 12px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }
  
  .chart-title {
    font-size: 1.2rem;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .chart-container {
    height: 300px;
    position: relative;
  }
  
  .table-card {
    background: rgba(255, 255, 255, 0.1);
    padding: 20px;
    border-radius: 12px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    margin-bottom: 30px;
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  
  th, td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  th {
    font-weight: 600;
    opacity: 0.8;
  }
  
  .status-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
  }
  
  .status-active {
    background: rgba(46, 204, 113, 0.3);
    color: #2ecc71;
  }
  
  .status-paused {
    background: rgba(241, 196, 15, 0.3);
    color: #f1c40f;
  }

  .reports-section {
    background: rgba(255, 255, 255, 0.1);
    padding: 20px;
    border-radius: 12px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    margin: 30px 0;
  }

  .reports-title {
    font-size: 1.3rem;
    font-weight: bold;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .reports-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .report-btn {
    padding: 10px 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .report-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
  }

  .report-btn:active {
    transform: translateY(0);
  }

  .report-btn.pdf {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  }

  .report-btn.pdf:hover {
    box-shadow: 0 8px 20px rgba(245, 87, 108, 0.4);
  }

  .report-btn.excel {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  }

  .report-btn.excel:hover {
    box-shadow: 0 8px 20px rgba(79, 172, 254, 0.4);
  }

  .report-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  .report-btn-loading::after {
    content: '';
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .reports-info {
    font-size: 0.9rem;
    opacity: 0.7;
    margin-top: 10px;
    padding: 10px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
  }
  
  .footer {
    text-align: center;
    margin-top: 30px;
    padding: 20px;
    opacity: 0.7;
    font-size: 0.9rem;
  }
  
  .loading {
    text-align: center;
    padding: 50px;
    font-size: 1.2rem;
  }
  
  .date-range-selector {
    display: flex;
    justify-content: center;
    margin: 15px 0;
  }

  .date-range-buttons {
    display: flex;
    gap: 10px;
  }

  .date-range-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    padding: 8px 15px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s;
    font-size: 0.9rem;
  }

  .date-range-btn:hover,
  .date-range-btn.active {
    background: rgba(255, 255, 255, 0.4);
  }

  /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫ */
  .metric-details {
    margin-top: 10px;
  }
  
  .metric-details p {
    margin: 5px 0;
    font-size: 0.9rem;
    opacity: 0.9;
  }
  
  .budget-card {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
  }
  
  .targets-card {
    background: linear-gradient(135deg, rgba(46, 204, 113, 0.2) 0%, rgba(39, 174, 96, 0.2) 100%);
  }
  
  .changes-card {
    background: linear-gradient(135deg, rgba(241, 196, 15, 0.2) 0%, rgba(243, 156, 18, 0.2) 100%);
  }
  
  @media (max-width: 768px) {
    .charts-grid {
      grid-template-columns: 1fr;
    }
    
    .metric-card {
      padding: 15px;
    }
    
    .metric-value {
      font-size: 1.8rem;
    }

    .auth-warning {
    background: rgba(231, 76, 60, 0.2);
    color: #e74c3c;
    padding: 15px;
    border-radius: 8px;
    margin: 20px 0;
    text-align: center;
    display: none;
  }

    .logout-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    padding: 8px 15px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s;
    display: flex;
    align-items: center;
    gap: 5px;
  }
  
  .logout-btn:hover {
    background: rgba(255, 255, 255, 0.4);
  }
  
  .user-info {
    position: absolute;
    top: 20px;
    left: 20px;
    font-size: 0.9rem;
    opacity: 0.8;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  }

  /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –∫–æ–º–ø–∞–Ω–∏–π */
#company-selector {
  background: rgba(255, 255, 255, 0.9) !important;
  color: #333 !important;
  border: 1px solid rgba(255, 255, 255, 0.3) !important;
}

#company-selector option {
  background: white !important;
  color: #333 !important;
  padding: 10px !important;
}

#company-selector option:hover {
  background: #667eea !important;
  color: white !important;
}

#company-selector:focus {
  outline: 2px solid rgba(102, 126, 234, 0.5);
}

#company-selector-container {
  animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è Choices.js —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ */
.company-select {
  width: 100%;
  opacity: 0;
  position: absolute;
  height: 0;
  pointer-events: none;
}

.choices {
  width: 100%;
  margin-bottom: 0;
  position: relative;
  z-index: 10000 !important; /* –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –æ—á–µ–Ω—å –≤—ã—Å–æ–∫–∏–π z-index */
}

.choices__inner {
  background: rgba(255, 255, 255, 0.95) !important;
  border: 1px solid rgba(102, 126, 234, 0.5) !important;
  border-radius: 8px !important;
  min-height: 42px !important;
  font-size: 14px !important;
  color: #333 !important;
  padding: 8px 12px !important;
  transition: all 0.3s ease !important;
  backdrop-filter: blur(10px);
  position: relative;
  z-index: 10001 !important;
}

.choices__inner:hover {
  background: rgba(255, 255, 255, 1) !important;
  border-color: rgba(102, 126, 234, 0.8) !important;
  box-shadow: 0 5px 15px rgba(102, 126, 234, 0.15) !important;
}

.choices__inner:focus {
  outline: none;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2) !important;
}

.choices__list--single {
  padding: 0 !important;
}

/* –°–ê–ú–û–ï –í–ê–ñ–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï - dropdown –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å fixed –∏ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º z-index */
.choices__list--dropdown,
.choices__list[aria-expanded] {
  background: rgba(255, 255, 255, 0.98) !important;
  border: 1px solid rgba(102, 126, 234, 0.5) !important;
  border-radius: 8px !important;
  margin-top: 8px !important;
  backdrop-filter: blur(10px) !important;
  z-index: 2147483647 !important; /* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤–æ–∑–º–æ–∂–Ω—ã–π z-index */
  box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3) !important;
  position: fixed !important; /* fixed –≤–º–µ—Å—Ç–æ absolute */
  max-height: 300px !important;
  overflow-y: auto !important;
  transform: none !important; /* –£–±–∏—Ä–∞–µ–º –ª—é–±—ã–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ */
}

/* –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è dropdown */
.choices__list--dropdown {
  left: var(--dropdown-left, auto) !important;
  top: var(--dropdown-top, auto) !important;
  width: var(--dropdown-width, auto) !important;
}

.choices__list--dropdown .choices__item--selectable,
.choices__list[aria-expanded] .choices__item--selectable {
  padding: 12px 15px !important;
  color: #333 !important;
  border-bottom: 1px solid rgba(0, 0, 0, 0.08) !important;
  font-size: 14px !important;
  transition: all 0.2s ease !important;
}

.choices__list--dropdown .choices__item--selectable:last-child,
.choices__list[aria-expanded] .choices__item--selectable:last-child {
  border-bottom: none !important;
}

.choices__list--dropdown .choices__item--selectable:hover,
.choices__list[aria-expanded] .choices__item--selectable:hover {
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%) !important;
  color: #667eea !important;
  transform: translateX(3px);
}

.choices__list--dropdown .choices__item--selectable.is-highlighted,
.choices__list[aria-expanded] .choices__item--selectable.is-highlighted {
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%) !important;
  color: #667eea !important;
  border-left: 3px solid #667eea !important;
}

.choices__item {
  font-size: 14px !important;
}

.choices__placeholder {
  opacity: 0.6 !important;
  color: #666 !important;
}

.choices__input {
  background: transparent !important;
  color: #333 !important;
  margin-bottom: 0 !important;
  font-size: 14px !important;
  padding: 8px !important;
}

.choices__input::placeholder {
  color: #999 !important;
}

.choices[data-type*="select-one"] .choices__inner {
  padding-bottom: 8px !important;
}

.choices[data-type*="select-one"]:after {
  border-color: #667eea transparent transparent transparent !important;
  right: 15px !important;
  top: 50% !important;
  transform: translateY(-50%) !important;
  transition: transform 0.3s ease !important;
  border-width: 6px !important;
  margin-top: 0 !important;
}

.choices[data-type*="select-one"].is-open:after {
  transform: translateY(-50%) rotate(180deg) !important;
  margin-top: 0 !important;
}

/* –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–±–∏—Ä–∞–µ–º backdrop-filter —É –º–µ—Ç—Ä–∏–∫, –∫–æ—Ç–æ—Ä—ã–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—Ç dropdown */
.metric-card,
.chart-card,
.table-card,
.reports-section {
  isolation: isolate; /* –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ç–µ–∫–∏–Ω–≥–∞ */
  z-index: 1;
  position: relative;
}

/* –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ header –Ω–µ —Å–æ–∑–¥–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º */
.header {
  position: relative;
  z-index: 10;
}

/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã—à–µ –≤—Å–µ–≥–æ */
#company-selector-container {
  position: relative;
  z-index: 100000;
}

#company-selector-container > div {
  position: relative;
  z-index: 100001;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–±—Ä–æ—Å–∞ */
#clear-company-filter {
  background: rgba(231, 76, 60, 0.2) !important;
  border: 1px solid rgba(231, 76, 60, 0.3) !important;
  color: #e74c3c !important;
  transition: all 0.3s ease !important;
  z-index: 100002;
  position: relative;
}

#clear-company-filter:hover {
  background: rgba(231, 76, 60, 0.3) !important;
  border-color: rgba(231, 76, 60, 0.5) !important;
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(231, 76, 60, 0.2);
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
  #company-selector-container {
    padding: 10px;
    margin-top: 10px;
  }
  
  #company-selector-container > div {
    flex-direction: column;
    align-items: stretch;
    gap: 10px !important;
  }
  
  .choices {
    max-width: 100% !important;
  }
  
  .choices__list--dropdown,
  .choices__list[aria-expanded] {
    left: 10px !important;
    right: 10px !important;
    width: calc(100% - 20px) !important;
    max-height: 50vh !important;
    margin-top: 5px !important;
  }
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ */
@keyframes fadeInDropdown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.choices__list--dropdown,
.choices__list[aria-expanded] {
  animation: fadeInDropdown 0.3s ease-out;
}

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<div class="dashboard">
  <!-- –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
  <div class="user-info">
    <i class="fas fa-user"></i>
    <span id="userEmail">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
    <span id="userRole" style="font-size: 0.8rem; background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 4px;">
      –ó–∞–≥—Ä—É–∑–∫–∞...
    </span>
  </div>
  
  <button class="logout-btn" id="logoutBtn">
    <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏
  </button>

  <!-- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ–± –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
  <div id="authWarning" class="auth-warning">
    <i class="fas fa-exclamation-triangle"></i>
    <span id="authWarningText">–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</span>
    <button id="retryAuthBtn" style="margin-left: 10px; padding: 5px 10px; background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 4px; cursor: pointer;">
      –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
    </button>
    <button id="goToLoginBtn" style="margin-left: 5px; padding: 5px 10px; background: rgba(46, 204, 113, 0.2); border: none; color: white; border-radius: 4px; cursor: pointer;">
      –í–æ–π—Ç–∏
    </button>
  </div>
  
  <div class="header">
    <h1><i class="fas fa-chart-line"></i> Order Master Analytics Dashboard</h1>
    <p>–°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>
    
    <div class="period-selector">
      <button class="period-btn active" data-period="today">–°–µ–≥–æ–¥–Ω—è</button>
      <button class="period-btn" data-period="yesterday">–í—á–µ—Ä–∞</button>
      <button class="period-btn" data-period="this_week">–≠—Ç–∞ –Ω–µ–¥–µ–ª—è</button>
      <button class="period-btn" data-period="this_month">–≠—Ç–æ—Ç –º–µ—Å—è—Ü</button>
    </div>

    <div id="company-selector-container" style="display: none; margin-top: 15px;">
      <div style="display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: wrap;">
        <label for="company-selector" style="font-size: 0.9rem; opacity: 0.9; white-space: nowrap;">
          <i class="fas fa-building"></i> –§–∏–ª—å—Ç—Ä –ø–æ –∫–æ–º–ø–∞–Ω–∏–∏:
        </label>
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è Choices.js -->
        <div style="position: relative; min-width: 250px; max-width: 400px;">
          <select id="company-selector" class="company-select" data-placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏—é...">
            <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
          </select>
        </div>
        <button id="clear-company-filter" class="period-btn" style="padding: 8px 12px; display: none;" title="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä">
          <i class="fas fa-times"></i> –°–±—Ä–æ—Å–∏—Ç—å
        </button>
      </div>
    </div>
    
    <div style="margin-top: 20px; font-size: 0.9rem; opacity: 0.8;">
      <i class="fas fa-sync-alt"></i> –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    </div>
  </div>
  
  <div id="loading" class="loading">
    <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
  </div>
  
  <div id="dashboard-content" style="display: none;">
    <!-- –ú–µ—Ç—Ä–∏–∫–∏ –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å -->
  </div>

  <!-- –°–µ–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–æ–≤ -->
  <div class="reports-section" style="display: none;" id="reportsSection">
    <div class="reports-title">
      <i class="fas fa-file-export"></i> –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á—ë—Ç–æ–≤
    </div>
    
    <div class="date-range-selector">
      <div class="date-range-buttons">
        <button class="date-range-btn active" data-period="today">–°–µ–≥–æ–¥–Ω—è</button>
        <button class="date-range-btn" data-period="this_week">–ù–µ–¥–µ–ª—è</button>
        <button class="date-range-btn" data-period="this_month">–ú–µ—Å—è—Ü</button>
      </div>
    </div>
    
    <div class="reports-buttons">
      <button class="report-btn pdf" id="generate-pdf-btn">
        <i class="fas fa-file-pdf"></i> –°–∫–∞—á–∞—Ç—å PDF
      </button>
      <button class="report-btn excel" id="generate-excel-btn">
        <i class="fas fa-file-excel"></i> –°–∫–∞—á–∞—Ç—å Excel
      </button>
    </div>
     <div class="reports-info">
       <i class="fas fa-info-circle"></i> 
       –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ –∫–∞–º–ø–∞–Ω–∏–π –Ω–∏–∂–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –∫–∞–º–ø–∞–Ω–∏—é –¥–ª—è –æ—Ç—á—ë—Ç–∞.
       –ü–µ—Ä–∏–æ–¥: –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç.
     </div>
  </div>
  
  <div class="footer">
    <p>Order Master Analytics System v1.0.0 | –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: <span id="last-update">--:--:--</span></p>
    <p>¬© 2024 Order Master. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
  </div>
</div>

<script>
let choicesInstance = null; // –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –≤ –Ω–∞—á–∞–ª–µ —Å–∫—Ä–∏–ø—Ç–∞
  let currentPeriod = 'today';
  let refreshInterval;
  let selectedCampaignId = null;
  let selectedPeriod = 'today';

  let selectedCompanyId = 'all';
  let selectedCompanyType = 'advertiser'; // 'advertiser' –∏–ª–∏ 'campaign'
  let availableCompanies = [];

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π/–∫–∞–º–ø–∞–Ω–∏–π
  async function loadAvailableCompanies(user) {
  try {
    const token = localStorage.getItem('authToken');
    let url = '';
    
    if (user.role === 'ADMIN') {
      // –ê–¥–º–∏–Ω –≤–∏–¥–∏—Ç –≤—Å–µ—Ö —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª–µ–π
      url = '/api/advertisers/list';
      selectedCompanyType = 'advertiser';
      console.log('üëë –ê–¥–º–∏–Ω –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª–µ–π —Å URL:', url);
    } else if (user.role === 'ADVERTISER') {
      // –†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Å–≤–æ–∏ –∫–∞–º–ø–∞–Ω–∏–∏
      url = '/api/campaigns/my';
      selectedCompanyType = 'campaign';
      console.log('üìä –†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∫–∞–º–ø–∞–Ω–∏–∏ —Å URL:', url);
    } else {
      console.warn('‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', user.role);
      return [];
    }
    
    const response = await fetch(url, {
      headers: {
        'Authorization': 'Bearer ' + token
      }
    });
    
    console.log('üì° –û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', {
      status: response.status,
      url: url,
      ok: response.ok
    });
    
    if (!response.ok) {
      const errorText = await response.text();
      console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π:', errorText);
      throw new Error(`HTTP ${response.status}: ${errorText}`);
    }
    
    const result = await response.json();
    console.log('üì¶ –î–∞–Ω–Ω—ã–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', result);
    
    if (result.success) {
      availableCompanies = result.data || [];
      console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∫–æ–º–ø–∞–Ω–∏–π: ${availableCompanies.length}`);
      return availableCompanies;
    } else {
      console.error('‚ùå –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É:', result.error);
      return [];
    }
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π:', {
      message: error.message,
      stack: error.stack
    });
    return [];
  }
}

// –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –∫–æ–º–ø–∞–Ω–∏–π —Å Choices.js
function renderCompanySelector(companies, userRole) {
  const container = document.getElementById('company-selector-container');
  const selector = document.getElementById('company-selector');
  const clearBtn = document.getElementById('clear-company-filter');
  
  if (!container || !selector) {
    console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç—ã —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
    return;
  }
  
  console.log('üìä –ö–æ–º–ø–∞–Ω–∏–∏ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞:', {
    userRole,
    companiesCount: companies.length,
    companies: companies
  });
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
  container.style.display = 'block';
  
  // –û—á–∏—â–∞–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä
  selector.innerHTML = '';
  
  // –°–æ–∑–¥–∞–µ–º placeholder option
  const placeholderOption = document.createElement('option');
  placeholderOption.value = '';
  placeholderOption.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏—é...';
  placeholderOption.disabled = false;
  selector.appendChild(placeholderOption);
  
  // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏—é "–í—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏"
  const allOption = document.createElement('option');
  allOption.value = 'all';
  allOption.textContent = '–í—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏';
  selector.appendChild(allOption);
  
  // –î–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏
  companies.forEach(company => {
    const option = document.createElement('option');
    option.value = String(company.id);
    
    let displayName = '';
    if (userRole === 'ADMIN') {
      displayName = company.name || company.email || `–†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å ID: ${company.id}`;
    } else if (userRole === 'ADVERTISER') {
      displayName = company.name || `–ö–∞–º–ø–∞–Ω–∏—è ID: ${company.id}`;
      if (company.status) {
        const statusText = company.status === 'active' ? '–∞–∫—Ç–∏–≤–Ω–∞' : '–Ω–∞ –ø–∞—É–∑–µ';
        displayName += ` (${statusText})`;
      }
    }
    
    option.textContent = displayName;
    option.setAttribute('data-custom-properties', JSON.stringify({
      name: company.name,
      email: company.email,
      status: company.status
    }));
    
    selector.appendChild(option);
  });
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º Choices.js
  if (!choicesInstance) {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Choices.js
    choicesInstance = new Choices(selector, {
      placeholder: true,
      placeholderValue: '–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏—é...',
      searchEnabled: true,
      searchChoices: true,
      searchFields: ['label'],
      searchPlaceholderValue: '–ü–æ–∏—Å–∫ –∫–æ–º–ø–∞–Ω–∏–∏...',
      itemSelectText: '',
      shouldSort: false,
      position: 'auto',
      resetScrollPosition: false,
      loadingText: '–ó–∞–≥—Ä—É–∑–∫–∞...',
      noResultsText: '–†–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ',
      noChoicesText: '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ–ø—Ü–∏–π',
      addItemText: (value) => `–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è "${value}"`,
      maxItemCount: -1,
      removeItemButton: false,
      classNames: {
        containerOuter: 'choices',
        containerInner: 'choices__inner',
        input: 'choices__input',
        inputCloned: 'choices__input--cloned',
        list: 'choices__list',
        listItems: 'choices__list--multiple',
        listSingle: 'choices__list--single',
        listDropdown: 'choices__list--dropdown',
        item: 'choices__item',
        itemSelectable: 'choices__item--selectable',
        itemDisabled: 'choices__item--disabled',
        itemChoice: 'choices__item--choice',
        placeholder: 'choices__placeholder',
        group: 'choices__group',
        groupHeading: 'choices__heading',
        button: 'choices__button',
        activeState: 'is-active',
        focusState: 'is-focused',
        openState: 'is-open',
        disabledState: 'is-disabled',
        highlightedState: 'is-highlighted',
        selectedState: 'is-selected',
        flippedState: 'is-flipped',
        loadingState: 'is-loading',
        noResults: 'has-no-results',
        noChoices: 'has-no-choices'
      }
    });
    
    console.log('‚úÖ Choices.js –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
  } else {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —ç–∫–∑–µ–º–ø–ª—è—Ä
    choicesInstance.setChoices(
      [
        { value: '', label: '–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏—é...', disabled: false },
        { value: 'all', label: '–í—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏' },
        ...companies.map(company => ({
          value: String(company.id),
          label: userRole === 'ADMIN' 
            ? (company.name || company.email || `–†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å ID: ${company.id}`)
            : (company.name || `–ö–∞–º–ø–∞–Ω–∏—è ID: ${company.id}`) + 
              (company.status ? ` (${company.status === 'active' ? '–∞–∫—Ç–∏–≤–Ω–∞' : '–Ω–∞ –ø–∞—É–∑–µ'})` : ''),
          customProperties: {
            name: company.name,
            email: company.email,
            status: company.status
          }
        }))
      ],
      'value',
      'label',
      false
    );
    
    console.log('‚úÖ Choices.js –æ–±–Ω–æ–≤–ª–µ–Ω');
  }
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –∑–Ω–∞—á–µ–Ω–∏—è
  selector.addEventListener('change', function(e) {
    const selectedValue = choicesInstance.getValue(true);
    console.log('üîò –í—ã–±—Ä–∞–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ:', selectedValue);
    
    if (selectedValue && selectedValue !== '') {
      selectedCompanyId = selectedValue;
      
      // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É —Å–±—Ä–æ—Å–∞
      if (clearBtn) {
        clearBtn.style.display = 'block';
        clearBtn.style.animation = 'fadeIn 0.3s ease-in';
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—à–±–æ—Ä–¥
      loadDashboardData(currentPeriod, selectedCompanyId, selectedCompanyType);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
      updateDashboardTitle(selectedCompanyId, selectedCompanyType, companies, userRole);
    }
  });
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–∫—Ä—ã—Ç–∏—è/–∑–∞–∫—Ä—ã—Ç–∏—è dropdown
  selector.addEventListener('showDropdown', function(e) {
    console.log('üìã Dropdown –æ—Ç–∫—Ä—ã—Ç');
  });
  
  selector.addEventListener('hideDropdown', function(e) {
    console.log('üìã Dropdown –∑–∞–∫—Ä—ã—Ç');
  });
  
  // –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–∞
  if (clearBtn) {
    clearBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
      choicesInstance.setChoiceByValue('');
      selectedCompanyId = 'all';
      
      // –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É —Å–±—Ä–æ—Å–∞
      this.style.display = 'none';
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—à–±–æ—Ä–¥
      loadDashboardData(currentPeriod, 'all', selectedCompanyType);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
      updateDashboardTitle('all', selectedCompanyType, companies, userRole);
      
      console.log('üóëÔ∏è –§–∏–ª—å—Ç—Ä —Å–±—Ä–æ—à–µ–Ω');
    });
  }
  
  // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ–≥–æ
  const savedCompanyId = localStorage.getItem('selectedCompanyId');
  if (savedCompanyId && choicesInstance) {
    setTimeout(() => {
      const optionExists = Array.from(selector.options).some(opt => opt.value === savedCompanyId);
      if (optionExists) {
        choicesInstance.setChoiceByValue(savedCompanyId);
        selectedCompanyId = savedCompanyId;
        
        if (clearBtn && savedCompanyId !== 'all' && savedCompanyId !== '') {
          clearBtn.style.display = 'block';
        }
        
        console.log('üíæ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä:', savedCompanyId);
      }
    }, 100);
  }
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
  selector.addEventListener('change', function() {
    if (selectedCompanyId) {
      localStorage.setItem('selectedCompanyId', selectedCompanyId);
    }
  });
  
  console.log(`‚úÖ –°–µ–ª–µ–∫—Ç–æ—Ä ${userRole} –æ—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω —Å Choices.js. –û–ø—Ü–∏–π: ${selector.options.length}`);
}

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  async function checkAuth() {
  console.log('üîê –ù–∞—á–∞–ª–æ checkAuth()');
  
  const serverToken = window.authToken || localStorage.getItem('authToken');
  console.log('üì¶ –¢–æ–∫–µ–Ω –∏–∑ localStorage:', serverToken ? '–ï—Å—Ç—å' : '–ù–µ—Ç');
  
  if (!serverToken) {
    console.log('‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∏ –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏, –Ω–∏ –≤ localStorage');
    showAuthError('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.');
    return null;
  }
  
  const token = serverToken.startsWith('Bearer ') 
    ? serverToken.split(' ')[1] 
    : serverToken;
  
  console.log('üîê –¢–æ–∫–µ–Ω –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:', token ? `–ï—Å—Ç—å (${token.length} —Å–∏–º–≤–æ–ª–æ–≤)` : '–ù–µ—Ç');
  
  try {
    console.log('üì° –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ /api/auth/validate...');
    
    const response = await fetch('/api/auth/validate', {
      method: 'GET',
      headers: {
        'Authorization': 'Bearer ' + token
      }
    });
    
    console.log('üì° –û—Ç–≤–µ—Ç –æ—Ç /api/auth/validate:', {
      status: response.status,
      statusText: response.statusText,
      ok: response.ok
    });
    
    const data = await response.json();
    console.log('üì¶ –î–∞–Ω–Ω—ã–µ –æ—Ç /api/auth/validate:', data);
    
    if (response.ok && data.success) {
    console.log('‚úÖ –¢–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', data.user);
    
    localStorage.setItem('authToken', token);
    
    // –í–û–ó–í–†–ê–©–ê–ï–ú –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
    const user = {
      id: data.user.id || data.user.userId || data.user.user_id,
      role: data.user.role,
      advertiserId: data.user.advertiserId || data.user.advertiser_id,
      email: data.user.email || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
    };
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
    window.currentUser = user;
    window.currentUserRole = user.role;
    
    console.log('üë§ –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', user);
    return user;
  } else {
      console.error('‚ùå –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞:', data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
      
      let errorMessage = '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏';
      switch (data.error) {
        case 'Token has expired':
          errorMessage = '–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Å–µ—Å—Å–∏–∏ –∏—Å—Ç–µ–∫. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.';
          break;
        case 'Invalid token signature':
          errorMessage = '–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–æ–¥–ø–∏—Å—å —Ç–æ–∫–µ–Ω–∞. –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥.';
          break;
        default:
          errorMessage = data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é';
      }

      showAuthError(errorMessage);
      logout();
      return null;
    }
  } catch (error) {
    console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞:', {
      message: error.message,
      name: error.name
    });
    
    showAuthError('–ü—Ä–æ–∏–∑–æ—à–ª–∞ —Å–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
    logout();
    return null;
  }
}

  function showAuthError(message) {
    document.getElementById('authWarningText').textContent = message;
    document.getElementById('authWarning').style.display = 'block';
    document.getElementById('dashboard-content').style.display = 'none';
    document.getElementById('reportsSection').style.display = 'none';
    document.getElementById('loading').style.display = 'none';
  }

  function hideAuthError() {
    document.getElementById('authWarning').style.display = 'none';
  }

  async function loadUserData(user) {
    if (!user) return;
    
    document.getElementById('userEmail').textContent = user.email || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    document.getElementById('userRole').textContent = user.role === 'ADMIN' ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : '–†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å';
  }

  async function loadDashboardData(period = 'today', companyId = 'all', companyType = 'advertiser') {
  const token = localStorage.getItem('authToken');
  
  if (!token) {
    console.error('‚ùå No token found in localStorage');
    showAuthError('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.');
    return;
  }

  const user = window.currentUser;
  
  if (!user) {
    console.error('‚ùå User not loaded');
    showAuthError('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.');
    return;
  }
    
    try {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('dashboard-content').style.display = 'none';
       // –°—Ç—Ä–æ–∏–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
    let url = `/api/dashboard/data?period=${period}`;

     // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∫–æ–º–ø–∞–Ω–∏–∏
     if (companyId && companyId !== 'all') {
      if (companyType === 'advertiser' || user.role === 'ADMIN') {
        // –î–ª—è –∞–¥–º–∏–Ω–∞ –∏–ª–∏ –≤—ã–±–æ—Ä–∞ —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—è
        url += `&advertiser_id=${companyId}`;
      } else if (companyType === 'campaign' || user.role === 'ADVERTISER') {
        // –î–ª—è —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—è –∏–ª–∏ –≤—ã–±–æ—Ä–∞ –∫–∞–º–ø–∞–Ω–∏–∏
        url += `&campaign_id=${companyId}`;
      }
    } else if (user.role === 'ADVERTISER' && user.advertiserId) {
      // –ï—Å–ª–∏ —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª "–≤—Å–µ", –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ–≥–æ –∫–∞–º–ø–∞–Ω–∏–∏
      url += `&advertiser_id=${user.advertiserId}`;
    }

    
      
      console.log('üîê Sending dashboard request with token', {
        tokenLength: token.length,
        period: period
      });
      
      const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      }
    });
      
      console.log('üì° Dashboard Response Status:', response.status);
      
      if (response.status === 401) {
        console.error('‚ùå Unauthorized access');
        showAuthError('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.');
        logout();
        return;
      }
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('‚ùå Dashboard Request Error', {
          status: response.status,
          statusText: response.statusText,
          errorText: errorText
        });
        throw new Error(`HTTP error ${response.status}: ${errorText}`);
      }
      
      const result = await response.json();
      
      if (result.success) {
        renderDashboard(result.data);
        hideAuthError();
        document.getElementById('loading').style.display = 'none';
        document.getElementById('dashboard-content').style.display = 'block';
        document.getElementById('reportsSection').style.display = 'block';
        updateLastUpdateTime();
      } else {
        throw new Error(result.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
      }
    } catch (error) {
      console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', {
        message: error.message,
        name: error.name,
        stack: error.stack
      });
      
      document.getElementById('loading').innerHTML = 
        '<i class="fas fa-exclamation-triangle"></i> –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message;
      
      showAuthError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ–π—Ç–∏ —Å–Ω–æ–≤–∞.');
      logout();
    }
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function getCurrentUser() {
  const token = localStorage.getItem('authToken');
  if (!token) return null;
  
  try {
    const response = await fetch('/api/auth/me', {
      headers: {
        'Authorization': 'Bearer ' + token
      }
    });
    
    if (response.ok) {
      return await response.json();
    }
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
  }
  
  return null;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –¥–∞—à–±–æ—Ä–¥–∞
function updateDashboardTitle(companyId, companyType, companies, userRole) {
  const titleElement = document.querySelector('.header h1');
  if (!titleElement) return;
  
  let companyName = '';
  
  if (companyId && companyId !== 'all' && companyId !== '') {
    // –ò—â–µ–º –∫–æ–º–ø–∞–Ω–∏—é
    const company = companies.find(c => String(c.id) === String(companyId));
    if (company) {
      if (userRole === 'ADMIN') {
        companyName = ` | –†–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª—å: ${company.name || company.email || `ID: ${company.id}`}`;
      } else if (userRole === 'ADVERTISER') {
        companyName = ` | –ö–∞–º–ø–∞–Ω–∏—è: ${company.name || `ID: ${company.id}`}`;
      }
    }
  } else if (userRole === 'ADVERTISER') {
    companyName = ' | –í—Å–µ –º–æ–∏ –∫–∞–º–ø–∞–Ω–∏–∏';
  } else if (userRole === 'ADMIN') {
    companyName = ' | –í—Å–µ —Ä–µ–∫–ª–∞–º–æ–¥–∞—Ç–µ–ª–∏';
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
  const originalText = 'Order Master Analytics Dashboard';
  titleElement.innerHTML = `
    <i class="fas fa-chart-line"></i> ${originalText}
    <small style="font-size: 0.6em; opacity: 0.8; display: block; margin-top: 5px;">
      ${companyName}
    </small>
  `;
}

  function logout() {
     // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä Choices.js
  if (choicesInstance) {
    choicesInstance.destroy();
    choicesInstance = null;
  }
    
    localStorage.removeItem('authToken');
    localStorage.removeItem('userRole');
    localStorage.removeItem('userId');
    localStorage.removeItem('advertiserId');
    window.location.href = '/login';
  }

  // –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –†–ï–ù–î–ï–†–ò–ù–ì–ê –î–ê–®–ë–û–†–î–ê
  function renderDashboard(data) {
    const container = document.getElementById('dashboard-content');
    const overview = data.overview;

    if (selectedCompanyId !== 'all' && availableCompanies.length > 0) {
    updateDashboardTitle(selectedCompanyId, selectedCompanyType, availableCompanies, window.currentUserRole);
  }
    
    // –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
    const metricsHtml = 
      '<div class="metrics-grid">' +
        '<div class="metric-card">' +
          '<div class="metric-label"><i class="fas fa-users"></i> –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–∏ (UV)</div>' +
          '<div class="metric-value">' +
            (overview.uv || 0).toLocaleString('ru-RU') +
            '<span class="metric-change ' + ((overview.change?.uv_change || 0) >= 0 ? 'positive' : 'negative') + '">' +
              ((overview.change?.uv_change || 0) >= 0 ? '+' : '') + (overview.change?.uv_change || 0).toFixed(1) + '%' +
            '</span>' +
          '</div>' +
          '<div class="metric-label">–û—Ö–≤–∞—Ç: ' + (overview.reach || 0).toLocaleString('ru-RU') + '</div>' +
        '</div>' +
        
        '<div class="metric-card">' +
          '<div class="metric-label"><i class="fas fa-eye"></i> –ü–æ–∫–∞–∑—ã</div>' +
          '<div class="metric-value">' +
            (overview.impressions || 0).toLocaleString('ru-RU') +
            '<span class="metric-change ' + ((overview.change?.impressions_change || 0) >= 0 ? 'positive' : 'negative') + '">' +
              ((overview.change?.impressions_change || 0) >= 0 ? '+' : '') + (overview.change?.impressions_change || 0).toFixed(1) + '%' +
            '</span>' +
          '</div>' +
          '<div class="metric-label">–ö–ª–∏–∫–∏: ' + (overview.clicks || 0).toLocaleString('ru-RU') + '</div>' +
        '</div>' +
        
        '<div class="metric-card">' +
          '<div class="metric-label"><i class="fas fa-mouse-pointer"></i> CTR</div>' +
          '<div class="metric-value">' +
            (overview.ctr || 0).toFixed(2) + '%' +
            '<span class="metric-change ' + ((overview.change?.ctr_change || 0) >= 0 ? 'positive' : 'negative') + '">' +
              ((overview.change?.ctr_change || 0) >= 0 ? '+' : '') + (overview.change?.ctr_change || 0).toFixed(1) + '%' +
            '</span>' +
          '</div>' +
          '<div class="metric-label">–ö–æ–Ω–≤–µ—Ä—Å–∏–∏: ' + (overview.conversions || 0).toLocaleString('ru-RU') + '</div>' +
        '</div>' +
        
        '<div class="metric-card">' +
          '<div class="metric-label"><i class="fas fa-chart-pie"></i> CR</div>' +
          '<div class="metric-value">' +
            (overview.cr || 0).toFixed(2) + '%' +
            '<span class="metric-change ' + ((overview.change?.cr_change || 0) >= 0 ? 'positive' : 'negative') + '">' +
              ((overview.change?.cr_change || 0) >= 0 ? '+' : '') + (overview.change?.cr_change || 0).toFixed(1) + '%' +
            '</span>' +
          '</div>' +
          '<div class="metric-label">' +
            'CPUV: ' + (overview.cpuv !== null && overview.cpuv !== undefined ? overview.cpuv.toFixed(2) + ' ‚ÇΩ' : '‚Äî') + ' | ' +
            'CPC: ' + (overview.cpc !== null && overview.cpc !== undefined ? overview.cpc.toFixed(2) + ' ‚ÇΩ' : '‚Äî') + ' | ' +
            'CPL: ' + (overview.cpl !== null && overview.cpl !== undefined ? overview.cpl.toFixed(2) + ' ‚ÇΩ' : '‚Äî') +
          '</div>' +
        '</div>' +
      '</div>';

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏: –±—é–¥–∂–µ—Ç, —Ü–µ–ª–∏, –∏–∑–º–µ–Ω–µ–Ω–∏—è
    let additionalMetricsHtml = '';
    
    if (overview.budget_status || overview.targets || overview.change) {
      additionalMetricsHtml = '<div class="metrics-grid">';
      
      // –ë—é–¥–∂–µ—Ç
      if (overview.budget_status) {
    const budget = overview.budget_status;
    const hasDetails = budget.spent !== undefined && budget.spent !== null;
    
    additionalMetricsHtml +=
        '<div class="metric-card budget-card">' +
            '<div class="metric-label"><i class="fas fa-wallet"></i> –°—Ç–∞—Ç—É—Å –±—é–¥–∂–µ—Ç–∞</div>' +
            '<div class="metric-details">' +
                '<p>–û–±—â–∏–π –±—é–¥–∂–µ—Ç: ' + (budget.total || 0).toFixed(2) + ' ‚ÇΩ</p>' +
                (hasDetails ? 
                    '<p>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ: ' + (budget.spent || 0).toFixed(2) + ' ‚ÇΩ</p>' +
                    '<p>–û—Å—Ç–∞–ª–æ—Å—å: ' + (budget.remaining || 0).toFixed(2) + ' ‚ÇΩ</p>' +
                    '<p>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ' + (budget.utilization || 0).toFixed(2) + '%</p>' +
                    '<p>–°—Ç–∞—Ç—É—Å: ' + (budget.status || '–ù/–î') + '</p>' +
                    (budget.campaign_count ? 
                        '<p>–ö–∞–º–ø–∞–Ω–∏–π: ' + budget.campaign_count + 
                        ' (–∞–∫—Ç–∏–≤–Ω—ã—Ö: ' + (budget.active_campaigns || 0) + ')</p>' : '')
                    : 
                    '<p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä –ø–æ –∫–∞–º–ø–∞–Ω–∏–∏ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏</p>') +
            '</div>' +
        '</div>';
} else {
    additionalMetricsHtml +=
        '<div class="metric-card budget-card">' +
            '<div class="metric-label"><i class="fas fa-wallet"></i> –°—Ç–∞—Ç—É—Å –±—é–¥–∂–µ—Ç–∞</div>' +
            '<div class="metric-details"><p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –±—é–¥–∂–µ—Ç–µ</p></div>' +
        '</div>';
}

if (overview.targets) {
    const targets = overview.targets;
    const hasTargets = targets.cpu_v_target || targets.cpc_target || targets.cpl_target;
    
    if (hasTargets) {
        additionalMetricsHtml +=
            '<div class="metric-card targets-card">' +
                '<div class="metric-label"><i class="fas fa-bullseye"></i> –¶–µ–ª–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</div>' +
                '<div class="metric-details">' +
                    (targets.cpu_v_target ? 
                        '<p>–°—Ä–µ–¥–Ω–∏–π —Ü–µ–ª–µ–≤–æ–π CPUV: ' + targets.cpu_v_target.toFixed(2) + ' ‚ÇΩ</p>' : '') +
                    (targets.cpc_target ? 
                        '<p>–°—Ä–µ–¥–Ω–∏–π —Ü–µ–ª–µ–≤–æ–π CPC: ' + targets.cpc_target.toFixed(2) + ' ‚ÇΩ</p>' : '') +
                    (targets.cpl_target ? 
                        '<p>–°—Ä–µ–¥–Ω–∏–π —Ü–µ–ª–µ–≤–æ–π CPL: ' + targets.cpl_target.toFixed(2) + ' ‚ÇΩ</p>' : '') +
                    (targets.campaigns_with_targets ? 
                        '<p>–ö–∞–º–ø–∞–Ω–∏–π —Å —Ü–µ–ª—è–º–∏: ' + targets.campaigns_with_targets + '</p>' : '') +
                '</div>' +
            '</div>';
    } else {
        additionalMetricsHtml +=
            '<div class="metric-card targets-card">' +
                '<div class="metric-label"><i class="fas fa-bullseye"></i> –¶–µ–ª–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</div>' +
                '<div class="metric-details"><p>–¶–µ–ª–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã</p></div>' +
            '</div>';
    }
} else {
    additionalMetricsHtml +=
        '<div class="metric-card targets-card">' +
            '<div class="metric-label"><i class="fas fa-bullseye"></i> –¶–µ–ª–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</div>' +
            '<div class="metric-details"><p>–¶–µ–ª–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã</p></div>' +
        '</div>';
}
      
      // –ò–∑–º–µ–Ω–µ–Ω–∏—è
      if (overview.change) {
        const change = overview.change;
        additionalMetricsHtml +=
          '<div class="metric-card changes-card">' +
            '<div class="metric-label"><i class="fas fa-chart-line"></i> –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞ –ø–µ—Ä–∏–æ–¥</div>' +
            '<div class="metric-details">' +
              '<p>UV: ' + (change.uv_change || 0).toFixed(2) + '%</p>' +
              '<p>–ü–æ–∫–∞–∑—ã: ' + (change.impressions_change || 0).toFixed(2) + '%</p>' +
              '<p>–ö–ª–∏–∫–∏: ' + (change.clicks_change || 0).toFixed(2) + '%</p>' +
              '<p>–ö–æ–Ω–≤–µ—Ä—Å–∏–∏: ' + (change.conversions_change || 0).toFixed(2) + '%</p>' +
            '</div>' +
          '</div>';
      }
      
      additionalMetricsHtml += '</div>';
    }

    // –¢–æ–ø –∫–∞–º–ø–∞–Ω–∏–π
    let campaignsHtml = '';
    if (data.campaigns && data.campaigns.length > 0) {
      campaignsHtml = 
        '<div class="table-card">' +
          '<h2 class="chart-title"><i class="fas fa-trophy"></i> –¢–æ–ø –∫–∞–º–ø–∞–Ω–∏–π –ø–æ –∫–æ–Ω–≤–µ—Ä—Å–∏—è–º</h2>' +
          '<table>' +
            '<thead>' +
              '<tr>' +
                '<th>–ö–∞–º–ø–∞–Ω–∏—è</th>' +
                '<th>–ö–æ–Ω–≤–µ—Ä—Å–∏–∏</th>' +
                '<th>–í—ã—Ä—É—á–∫–∞</th>' +
                '<th>CTR</th>' +
                '<th>CR</th>' +
                '<th>CPUV</th>' +
                '<th>CPC</th>' +
                '<th>CPL</th>' +
                '<th>–°—Ç–∞—Ç—É—Å</th>' +
              '</tr>' +
            '</thead>' +
            '<tbody>' +
              data.campaigns.map(campaign => 
                '<tr data-campaign-id="' + campaign.id + '" style="cursor: pointer;" onclick="selectCampaign(' + campaign.id + ')" title="–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫–∞–º–ø–∞–Ω–∏–∏">' +
                  '<td><strong>' + campaign.name + '</strong></td>' +
                  '<td>' + campaign.conversions + '</td>' +
                  '<td>' + (campaign.revenue ? campaign.revenue.toFixed(2) + ' ‚ÇΩ' : '‚Äî') + '</td>' +
                  '<td>' + campaign.ctr + '%</td>' +
                  '<td>' + campaign.cr + '%</td>' +
                  '<td>' + (campaign.cpuv !== null ? campaign.cpuv.toFixed(2) + ' ‚ÇΩ' : '‚Äî') + '</td>' +
                  '<td>' + (campaign.cpc !== null ? campaign.cpc.toFixed(2) + ' ‚ÇΩ' : '‚Äî') + '</td>' +
                  '<td>' + (campaign.cpl !== null ? campaign.cpl.toFixed(2) + ' ‚ÇΩ' : '‚Äî') + '</td>' +
                  '<td>' +
                    '<span class="status-badge ' + (campaign.status === 'active' ? 'status-active' : 'status-paused') + '">' +
                      (campaign.status === 'active' ? '–ê–∫—Ç–∏–≤–Ω–∞' : '–ù–∞ –ø–∞—É–∑–µ') +
                    '</span>' +
                  '</td>' +
                '</tr>'
              ).join('') +
            '</tbody>' +
          '</table>' +
        '</div>';
    } else {
      campaignsHtml = 
        '<div class="table-card">' +
          '<h2 class="chart-title"><i class="fas fa-trophy"></i> –¢–æ–ø –∫–∞–º–ø–∞–Ω–∏–π –ø–æ –∫–æ–Ω–≤–µ—Ä—Å–∏—è–º</h2>' +
          '<p style="text-align: center; padding: 20px; opacity: 0.7;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∫–∞–º–ø–∞–Ω–∏—è—Ö</p>' +
        '</div>';
    }
    
    // –í–æ—Ä–æ–Ω–∫–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–π
    let funnelHtml = '';
    if (data.funnel) {
      const funnel = data.funnel;
      funnelHtml = 
        '<div class="charts-grid">' +
          '<div class="chart-card">' +
            '<h2 class="chart-title"><i class="fas fa-filter"></i> –í–æ—Ä–æ–Ω–∫–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–π</h2>' +
            '<div class="chart-container">' +
              '<div style="display: flex; flex-direction: column; gap: 20px; height: 100%;">' +
                ['–°–µ—Å—Å–∏–∏', '–ü–æ–∫–∞–∑—ã', '–ö–ª–∏–∫–∏', '–ö–æ–Ω–≤–µ—Ä—Å–∏–∏'].map(function(stage, index) {
                  const values = [funnel.sessions, funnel.impressions, funnel.clicks, funnel.conversions];
                  const percentages = [100, funnel.rates.impression_rate, funnel.rates.click_through_rate, funnel.rates.conversion_rate];
                  const dropoffs = [0, funnel.dropoffs.sessions_to_impressions, funnel.dropoffs.impressions_to_clicks, funnel.dropoffs.clicks_to_conversions];
                  
                  return (
                    '<div style="display: flex; align-items: center; gap: 15px;">' +
                      '<div style="flex: 0 0 100px; font-weight: 600;">' + stage + '</div>' +
                      '<div style="flex: 1; background: rgba(255,255,255,0.1); height: 40px; border-radius: 8px; overflow: hidden; position: relative;">' +
                        '<div style="width: ' + percentages[index] + '%; height: 100%; background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);"></div>' +
                        '<div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; font-weight: 600;">' +
                          values[index].toLocaleString('ru-RU') + ' (' + percentages[index].toFixed(1) + '%)' +
                        '</div>' +
                      '</div>' +
                      (dropoffs[index] > 0 ? 
                        '<div style="flex: 0 0 80px; text-align: right; font-size: 0.9rem; opacity: 0.7;">' +
                          '- ' + dropoffs[index] +
                        '</div>' 
                      : '') +
                    '</div>'
                  );
                }).join('') +
              '</div>' +
            '</div>' +
          '</div>';
      
      // –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —á–∞—Å–∞–º
      if (data.hourly && data.hourly.length > 0) {
        funnelHtml +=
          '<div class="chart-card">' +
            '<h2 class="chart-title"><i class="fas fa-chart-bar"></i> –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ —á–∞—Å–∞–º</h2>' +
            '<div class="chart-container">' +
              '<div style="display: flex; height: 100%; align-items: flex-end; gap: 4px;">' +
                data.hourly.slice(-12).map(hour => 
                  '<div style="flex: 1; display: flex; flex-direction: column; align-items: center; height: 100%;">' +
                    '<div style="flex: 1; display: flex; align-items: flex-end; width: 100%;">' +
                      '<div style="width: 100%; background: linear-gradient(0deg, #4facfe 0%, #00f2fe 100%); border-radius: 4px 4px 0 0; height: ' + (hour.impressions / 300 * 100) + '%;"></div>' +
                    '</div>' +
                    '<div style="padding-top: 8px; font-size: 0.8rem; opacity: 0.8;">' + hour.label + '</div>' +
                    '<div style="font-size: 0.7rem; opacity: 0.6; margin-top: 2px;">' + hour.impressions + '</div>' +
                  '</div>'
                ).join('') +
              '</div>' +
            '</div>' +
          '</div>';
      }
      
      funnelHtml += '</div>';
    }
    
    // –°–≤–æ–¥–∫–∞
    const summaryHtml = 
      '<div style="background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 10px; margin: 20px 0; font-size: 0.9rem;">' +
        '<div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px;">' +
          '<div><i class="fas fa-calendar"></i> –ü–µ—Ä–∏–æ–¥: ' + (data.summary?.period === 'today' ? '–°–µ–≥–æ–¥–Ω—è' : data.summary?.period || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ') + '</div>' +
          '<div><i class="fas fa-rocket"></i> –ê–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π: ' + (data.summary?.active_campaigns || 0) + ' –∏–∑ ' + (data.summary?.total_campaigns || 0) + '</div>' +
          (data.realtime ? 
            '<div><i class="fas fa-clock"></i> –ü–∏–∫–æ–≤—ã–π —á–∞—Å: ' + data.realtime.peak_hour.hour + ':00 (' + data.realtime.peak_hour.impressions + ' –ø–æ–∫–∞–∑–æ–≤)</div>' +
            '<div><i class="fas fa-users"></i> –ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π: ' + data.realtime.active_sessions + '</div>' 
          : '') +
        '</div>' +
      '</div>';
    
    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –≤–º–µ—Å—Ç–µ
    container.innerHTML = metricsHtml + additionalMetricsHtml + summaryHtml + funnelHtml + campaignsHtml;
  }

  function updateLastUpdateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    document.getElementById('last-update').textContent = timeString;
  }

  function selectCampaign(campaignId) {
    selectedCampaignId = campaignId;
    document.querySelectorAll('tr[data-campaign-id]').forEach(row => {
      row.style.background = '';
    });
    
    const selectedRow = document.querySelector('tr[data-campaign-id="' + campaignId + '"]');
    if (selectedRow) {
      selectedRow.style.background = 'rgba(102, 126, 234, 0.3)';
    }
    console.log('‚úÖ –í—ã–±—Ä–∞–Ω–∞ –∫–∞–º–ø–∞–Ω–∏—è: ' + campaignId);
  }

  async function generateReport(format) {
    if (!checkAuth()) return;
    
    const btnId = 'generate-' + format + '-btn';
    const btn = document.getElementById(btnId);
    btn.disabled = true;
    btn.classList.add('report-btn-loading');
    
    try {
      let campaignId = selectedCampaignId;
      
      if (!campaignId) {
        const firstCampaignRow = document.querySelector('tr[data-campaign-id]');
        if (firstCampaignRow) {
          campaignId = firstCampaignRow.getAttribute('data-campaign-id');
          selectCampaign(campaignId);
        }
      }
      
      if (!campaignId) {
        alert('‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–ø–∞–Ω–∏—é –∏–∑ —Ç–∞–±–ª–∏—Ü—ã');
        return;
      }

      const token = localStorage.getItem('authToken');
      const url = '/api/reports/campaign/' + campaignId + '/' + format + '?period=' + selectedPeriod;
      
      const response = await fetch(url, {
        headers: {
          'Authorization': 'Bearer ' + token
        }
      });
      
      if (response.status === 401) {
        logout();
        return;
      }
      
      if (!response.ok) {
        throw new Error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞');
      }
      
      const blob = await response.blob();
      const downloadUrl = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = downloadUrl;
      
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];
      link.download = 'report_campaign_' + campaignId + '_' + selectedPeriod + '_' + todayStr + '.' + (format === 'pdf' ? 'pdf' : 'xlsx');
      
      document.body.appendChild(link);
      link.click();
      window.URL.revokeObjectURL(downloadUrl);
      document.body.removeChild(link);

      alert('‚úÖ –û—Ç—á—ë—Ç ' + format.toUpperCase() + ' –¥–ª—è –∫–∞–º–ø–∞–Ω–∏–∏ ' + campaignId + ' –∑–∞ –ø–µ—Ä–∏–æ–¥ "' + selectedPeriod + '" —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!');
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞:', error);
      alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
    } finally {
      btn.disabled = false;
      btn.classList.remove('report-btn-loading');
    }
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  document.addEventListener('DOMContentLoaded', async function() {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞—à–±–æ—Ä–¥–∞...');
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
  const user = await checkAuth();
  
  if (!user) {
    showAuthError('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.');
    return;
  }

  console.log('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', user);

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ UI
  loadUserData(user);
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π/–∫–∞–º–ø–∞–Ω–∏–π
  console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π...');
  const companies = await loadAvailableCompanies(user);
  
  console.log('üìã –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏:', {
    count: companies.length,
    companies: companies
  });
  
   // –†–µ–Ω–¥–µ—Ä–∏–º —Å–µ–ª–µ–∫—Ç–æ—Ä –∫–æ–º–ø–∞–Ω–∏–π
   renderCompanySelector(companies, user.role);
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
  updateDashboardTitle('all', user.role === 'ADMIN' ? 'advertiser' : 'campaign', companies, user.role);
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–≤—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏)
  loadDashboardData(currentPeriod, 'all', user.role === 'ADMIN' ? 'advertiser' : 'campaign');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
    updateDashboardTitle('all', user.role === 'ADMIN' ? 'advertiser' : 'campaign', companies, user.role);
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    loadUserData(user);
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadDashboardData(currentPeriod);
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –ø–µ—Ä–∏–æ–¥–∞ –¥–∞—à–±–æ—Ä–¥–∞
    document.querySelectorAll('.period-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentPeriod = this.dataset.period;
        loadDashboardData(currentPeriod);
      });
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –ø–µ—Ä–∏–æ–¥–∞ –æ—Ç—á–µ—Ç–æ–≤
    document.querySelectorAll('.date-range-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.date-range-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        selectedPeriod = this.dataset.period;
        console.log('‚úÖ –í—ã–±—Ä–∞–Ω –ø–µ—Ä–∏–æ–¥ –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤: ' + selectedPeriod);
      });
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–æ–≤
    document.getElementById('generate-pdf-btn').addEventListener('click', () => generateReport('pdf'));
    document.getElementById('generate-excel-btn').addEventListener('click', () => generateReport('excel'));
    
    // –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞
    document.getElementById('logoutBtn').addEventListener('click', logout);
    
    // –ö–Ω–æ–ø–∫–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    document.getElementById('retryAuthBtn').addEventListener('click', async () => {
      const user = await checkAuth();
      if (user) {
        loadDashboardData(currentPeriod);
      }
    });
    
    document.getElementById('goToLoginBtn').addEventListener('click', () => {
      window.location.href = '/login';
    });
    
    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    refreshInterval = setInterval(() => {
      loadDashboardData(currentPeriod);
    }, 30000);
  });
  
  // –û—á–∏—Å—Ç–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
      clearInterval(refreshInterval);
    }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

</body>
</html>